<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="robots" content="index, follow"><title>带标签文本分类工具 • Tiko's blog</title><meta name="description" content="带标签文本分类工具 - Tiko"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="https://unpkg.com/nanoreset@3.0.1/nanoreset.min.css"><link rel="stylesheet" href="/css/theme.css"><link rel="search" type="application/opensearchdescription+xml" href="/atom.xml" title="Tiko's blog"><!--Global site tag (gtag.js) - Google Analytics--><script async src="https://www.googletagmanager.com/gtag/js?id=UA-155875637-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());

gtag('config', 'UA-155875637-1');</script><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Tiko's blog" type="application/atom+xml">
</head><body><div class="wrap" id="barba-wrapper"><header><h1 class="branding"><a href="/" title="Tiko's blog"><img class="logo-image" src="/logo.svg" alt="logo"></a></h1><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link no-barba" href="/" target="_self">HOME</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="/archives" target="_self">ARCHIVES</a></li><li class="nav-list-item"><a class="nav-list-link no-barba" href="https://github.com/Tiko-Lz1e" target="_blank">GITHUB</a></li></ul></header><div class="barba-container"><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">带标签文本分类工具</h1><div class="post-info"><a></a>2020-01-08<!--if theme.busuanzi && theme.busuanzi.enable && is_post()span#busuanzi_container_page_pv() <span class="post-meta-divider">|</span> 阅读量<span id="busuanzi_value_page_pv"></span>次--></div><div class="post-content"><h2 id="任务目标"><a href="#任务目标" class="headerlink" title="任务目标"></a>任务目标</h2><p>现在有一些带有标签的数据储存在不含header的tsv文件中（格式如下），需要使用正则表达式来判断后面的文本数据是否符合前面所有的标签。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A,B,	这条文本仅符合标签A</span><br><span class="line">C,	这条文本符合标签C</span><br></pre></td></tr></table></figure>

<h2 id="一、跨平台带来的问题"><a href="#一、跨平台带来的问题" class="headerlink" title="一、跨平台带来的问题"></a>一、跨平台带来的问题</h2><h3 id="1-文件编码问题"><a href="#1-文件编码问题" class="headerlink" title="1. 文件编码问题"></a>1. 文件编码问题</h3><p>win平台默认使用GB2312编码，而mac平台默认使用utf-8编码，这里使用chardet.detect()函数先行对文件编码方式进行判断。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_file_encoding</span><span class="params">(self, file)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    辨别文件编码方式</span></span><br><span class="line"><span class="string">    :param file: 文件路径</span></span><br><span class="line"><span class="string">    :return: 文件编码方式</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">with</span> open(file, <span class="string">'rb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">return</span> chardet.detect(f.read())[<span class="string">'encoding'</span>]</span><br></pre></td></tr></table></figure>

<h3 id="2-清屏问题"><a href="#2-清屏问题" class="headerlink" title="2. 清屏问题"></a>2. 清屏问题</h3><p>使用os.name来获取平台标记，在不同的平台使用不同的清屏命令</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">screen_cleaner</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    根据平台进行清屏操作</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> self.plat <span class="keyword">is</span> <span class="string">'nt'</span>:  <span class="comment"># win系列平台</span></span><br><span class="line">        os.system(<span class="string">'cls'</span>)</span><br><span class="line">    <span class="keyword">else</span>:   <span class="comment"># Linux系列平台</span></span><br><span class="line">        os.system(<span class="string">"clear"</span>)</span><br></pre></td></tr></table></figure>

<h2 id="二、读取文件中的数据"><a href="#二、读取文件中的数据" class="headerlink" title="二、读取文件中的数据"></a>二、读取文件中的数据</h2><h3 id="1-历史记录功能"><a href="#1-历史记录功能" class="headerlink" title="1. 历史记录功能"></a>1. 历史记录功能</h3><p>由于数据量比较大，在处理过程中可能需要中断处理，并且希望在下次读取该文件时，继续上次的进度。<br>可以在结果文件夹中创建一个名为“history.txt”的文件，当接收到键盘输入中断时，捕获KeyboardInterrupt异常，将当前进度写入。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    self.screen_cleaner()</span><br><span class="line">    <span class="keyword">if</span> self.re_confirm(<span class="string">"是否更新历史信息?"</span>):</span><br><span class="line">        self.classes.update(classes)</span><br><span class="line">        <span class="keyword">with</span> open(data[<span class="string">'info'</span>][<span class="string">'h_file_path'</span>], <span class="string">"w"</span>, encoding=<span class="string">"UTF-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(str(i))</span><br></pre></td></tr></table></figure>
<p>当每次打开一个数据文件时，检查该文件是否存在。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> open(h_file_path, <span class="string">"r"</span>, encoding=<span class="string">"UTF-8"</span>) <span class="keyword">as</span> f:</span><br><span class="line">        info[<span class="string">'history'</span>] = int(f.read())</span><br><span class="line"><span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">    info[<span class="string">"history"</span>] = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="2-用户确认"><a href="#2-用户确认" class="headerlink" title="2. 用户确认"></a>2. 用户确认</h3><p>由于没有撤回功能，当用户进行某些操作，比如中止分类时，可能需要用户再次进行确认。<br>我们可以写一个re_confirm函数来实现这个功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">re_confirm</span><span class="params">(self, msg)</span>:</span></span><br><span class="line">    c = input(<span class="string">"\n[!]"</span> + msg + <span class="string">"[Y/N]:\n"</span>)</span><br><span class="line">    confirm = <span class="literal">True</span> <span class="keyword">if</span> c <span class="keyword">in</span> <span class="string">"yY"</span> <span class="keyword">else</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> confirm</span><br></pre></td></tr></table></figure>

<h3 id="3-读取数据文件"><a href="#3-读取数据文件" class="headerlink" title="3. 读取数据文件"></a>3. 读取数据文件</h3><p>这时，我们就可以读取文件中的数据，准备开始分类工作了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(file_path, <span class="string">"r"</span>, encoding=info[<span class="string">'encoding'</span>]) <span class="keyword">as</span> f:</span><br><span class="line">    f_lines = f.readlines()</span><br><span class="line">    f_list = []</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f_lines:</span><br><span class="line">        line_cuted = line.split(<span class="string">'\t'</span>)</span><br><span class="line">        list_tag = line_cuted[<span class="number">0</span>].split(<span class="string">','</span>)[:<span class="number">-1</span>]</span><br><span class="line">        text = <span class="string">""</span>.join(line_cuted[<span class="number">-1</span>].split())</span><br><span class="line">        f_list.append([list_tag, text])</span><br><span class="line">    pre_len = len(f_list)</span><br></pre></td></tr></table></figure>

<h2 id="三、分类处理"><a href="#三、分类处理" class="headerlink" title="三、分类处理"></a>三、分类处理</h2><h3 id="1-手动分类"><a href="#1-手动分类" class="headerlink" title="1. 手动分类"></a>1. 手动分类</h3><p>我们可以将数据和标签依次显示在终端中，等待用户输入数字进行分类。<br>此时我们希望用户至少输入一个数字，所以对变量c进行了长度判断。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> trange(i, length):</span><br><span class="line">    line = data[<span class="string">'list'</span>][i]</span><br><span class="line">    <span class="comment"># 这一部分需要根据数据格式进行修改</span></span><br><span class="line">    text = <span class="string">""</span>.join(line[<span class="number">-1</span>].split())</span><br><span class="line">    tags = line[<span class="number">0</span>]</span><br><span class="line">    print(<span class="string">'\n\n'</span> + str(tags) + <span class="string">'\n'</span>)</span><br><span class="line">    print(text + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">    c = <span class="string">""</span>  <span class="comment"># 记录用户输入的类别号</span></span><br><span class="line">    <span class="keyword">while</span> len(c) &lt; <span class="number">1</span>:</span><br><span class="line">        c = input(<span class="string">"请输入类别号："</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        classes[c].append(line)</span><br><span class="line">    <span class="keyword">except</span> KeyError:</span><br><span class="line">        classes[c] = [line]</span><br><span class="line"></span><br><span class="line">    self.screen_cleaner()</span><br></pre></td></tr></table></figure>

<h3 id="2-自动分类"><a href="#2-自动分类" class="headerlink" title="2. 自动分类"></a>2. 自动分类</h3><h4 id="2-1-规则文件"><a href="#2-1-规则文件" class="headerlink" title="2.1 规则文件"></a>2.1 规则文件</h4><p>在自动分类的情况下，我们希望将标签对应的正则表达式写在tsv文件中，格式如下，前面为标签，后面为一个或多个正则表达式，用tab分隔。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A	^.*[A]	^.*[a]</span><br><span class="line">B	^.*[Bb]</span><br><span class="line">C	^.*[Cc]</span><br></pre></td></tr></table></figure>

<h4 id="2-2-自动分类"><a href="#2-2-自动分类" class="headerlink" title="2.2 自动分类"></a>2.2 自动分类</h4><p>读取了规则，就可以进行自动化的分类。<br>我们可以使用一个log变量来决定是否展示每一个数据分类的结果并等待用户确认。<br>同时，我们可以使用tqdm库实现一个进度条。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> trange(i, length) <span class="keyword">as</span> t:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> t:</span><br><span class="line">        line = data[<span class="string">'list'</span>][i]</span><br><span class="line">        <span class="comment"># 这一部分需要根据数据格式进行修改</span></span><br><span class="line">        text = <span class="string">""</span>.join(line[<span class="number">-1</span>].split())</span><br><span class="line">        tags = line[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> log:</span><br><span class="line">            print(<span class="string">'\n\n'</span> + str(tags) + <span class="string">'\n'</span>)</span><br><span class="line">            print(text + <span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">        c = <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> tag <span class="keyword">in</span> tags:</span><br><span class="line">            <span class="keyword">if</span> tag <span class="keyword">not</span> <span class="keyword">in</span> patterns[<span class="number">0</span>]:</span><br><span class="line">                <span class="keyword">if</span> log:</span><br><span class="line">                    print(<span class="string">"\n[!]Tag【&#123;0&#125;】不存在对应的规则\n"</span>.format(tag))</span><br><span class="line">                c = <span class="string">"包含未经处理的Tag"</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                flag = <span class="number">0</span></span><br><span class="line">                <span class="keyword">for</span> pattern_c <span class="keyword">in</span> patterns[<span class="number">1</span>][tag]:</span><br><span class="line">                    pattern_c = <span class="string">""</span>.join(pattern_c.split())</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        <span class="keyword">if</span> re.match(pattern_c, text):</span><br><span class="line">                            <span class="keyword">if</span> log:</span><br><span class="line">                                print(<span class="string">"\n[+]Tag【&#123;0&#125;】与规则【&#123;1&#125;】匹配\n"</span>.format(tag, pattern_c))</span><br><span class="line">                            flag = <span class="number">1</span></span><br><span class="line">                            <span class="keyword">if</span> len(c) &lt; <span class="number">1</span>:</span><br><span class="line">                                c = <span class="string">"匹配"</span></span><br><span class="line">                    <span class="keyword">except</span> re.error:</span><br><span class="line">                        <span class="keyword">if</span> log:</span><br><span class="line">                            print(<span class="string">"\n[!]正则表达式【&#123;0&#125;】格式错误\n"</span>.format(pattern_c))</span><br><span class="line">                            input()</span><br><span class="line">                <span class="keyword">if</span> flag == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">if</span> log:</span><br><span class="line">                        print(<span class="string">"\n[-]Tag【&#123;0&#125;】不存在与文本相匹配的规则\n"</span>.format(tag))</span><br><span class="line">                    <span class="keyword">if</span> c != <span class="string">"包含未经处理的Tag"</span>:</span><br><span class="line">                        c = <span class="string">"不匹配"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> log:</span><br><span class="line">            print(<span class="string">"\n分类信息：&#123;&#125;"</span>.format(c))</span><br><span class="line">            input()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># if line not in classes[c]:  # 去重</span></span><br><span class="line">            classes[c].append(line)</span><br><span class="line">        <span class="keyword">except</span> KeyError:</span><br><span class="line">            classes[c] = [line]</span><br><span class="line">        <span class="keyword">if</span> log:</span><br><span class="line">            self.screen_cleaner()</span><br><span class="line">t.close()</span><br><span class="line">self.classes.update(classes)</span><br></pre></td></tr></table></figure>

<h3 id="3-退出分类器"><a href="#3-退出分类器" class="headerlink" title="3. 退出分类器"></a>3. 退出分类器</h3><p>用户在退出时，如果有尚未保存的数据，进行提醒。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">classifier_closer</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> self.classes:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.re_confirm(<span class="string">"还有数据尚未保存，是否确认退出?"</span>):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    print(<span class="string">"\n【退出Tiko分类器】\n"</span>)</span><br><span class="line">    sys.exit()</span><br></pre></td></tr></table></figure>

<h2 id="三、项目GitHub地址"><a href="#三、项目GitHub地址" class="headerlink" title="三、项目GitHub地址"></a>三、项目GitHub地址</h2><p><a href="https://github.com/Tiko-Lz1e/Tiko_classifier" target="_blank" rel="noopener">https://github.com/Tiko-Lz1e/Tiko_classifier</a></p>
</div></article></div></main><footer><div class="paginator"><a class="next" href="/2020/01/08/hello-world/">next</a></div><div class="copyright"><!--p &copy; #{copyrightYear} #[a(href=copyrightURL) #{copyrightName}]br
| Powered by <a href="https://hexo.io/" rel="noreferrer" target="_blank">Hexo</a>--></div></footer></div></div><script>var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-155875637-1']);
_gaq.push(['_trackPageview']);

(function () {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();</script><script src="https://cdnjs.cloudflare.com/ajax/libs/barba.js/1.0.0/barba.min.js"></script><script>document.addEventListener('DOMContentLoaded', function() {
    Barba.Pjax.start()
})</script></body></html>